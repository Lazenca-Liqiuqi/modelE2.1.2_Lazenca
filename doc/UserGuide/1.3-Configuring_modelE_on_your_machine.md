# Configuring modelE on your machine / 在您的机器上配置ModelE

## Introduction / 介绍

Before you start working with modelE you have to make sure that all necessary software is installed on your computer. This includes a Fortran compiler (gfortran or intel), netcdf library, MPI library, Git and wget.
在开始使用ModelE之前，您必须确保所有必要的软件都已安装在您的计算机上。这包括Fortran编译器（gfortran或intel）、netcdf库、MPI库、Git和wget。

On Mac OS computer you can install all this software with MacPorts (MacPorts have to be installed on your computer, see [MacPorts installation guide](https://www.macports.org/install.php) for instructions). The following instructions assume that you are going to work with gfortran 4.9 compiler:
在Mac OS计算机上，您可以使用MacPorts安装所有这些软件（MacPorts必须安装在您的计算机上，请参阅[MacPorts安装指南](https://www.macports.org/install.php)获取说明）。以下说明假设您将使用gfortran 4.9编译器：

```bash
sudo port -v install gcc49
sudo port -v install netcdf +gcc49
sudo port -v install netcdf-fortran +gcc49
sudo port -v install openmpi +gcc49
sudo port -v install git-core
sudo port -v install wget
sudo port select --set gcc mp-gcc49
```

Make sure that the directiry with MacPorts executables (`/opt/local/bin`) appears in your `PATH` before any of the system directories (this is necessary so that the model uses `cpp` provided by MacPorts, rather than the one which comes with Xcode and lacks GNU compatibility).
确保包含MacPorts可执行文件的目录（`/opt/local/bin`）在任何系统目录之前出现在您的`PATH`中（这是必要的，这样模型将使用MacPorts提供的`cpp`，而不是Xcode自带的缺乏GNU兼容性的那个）。

On Linux machine you can also install these with the package manager (say, with `yum` on CentOS), but it is advisable to compile netcdf and openmpi from the source to ensure their compatibility with the fortran compiler you are using. If you are running relatively "new" version of Linux (like Fedora 22) you can install all necessary binary packages with:
在Linux机器上，您也可以使用包管理器安装这些软件（例如，在CentOS上使用`yum`），但建议从源代码编译netcdf和openmpi，以确保它们与您使用的Fortran编译器兼容。如果您运行的是相对"新"版本的Linux（如Fedora 22），您可以使用以下命令安装所有必要的二进制包：

```bash
yum install gcc.x86_64
yum install gcc-gfortran.x86_64
yum install gcc-c++.x86_64
yum install git
yum install netcdf.x86_64
yum install netcdf-fortran.x86_64
yum install netcdf-devel.x86_64
yum install netcdf-fortran-devel.x86_64
yum install openmpi.x86_64
yum install openmpi-devel.x86_64
```

On Linux, if using yum package for MPI, typically you have to enable it with something like:
在Linux上，如果使用yum安装的MPI包，通常您需要使用类似以下的命令启用它：

```bash
module load openmpi-x86_64
```

before you can use in in your shell window. (you may want to add this command to your ~/.profile).
然后才能在您的shell窗口中使用它。（您可能需要将此命令添加到您的~/.profile中）。

On enterprise Linux platforms (such as RedHat or CentOS) the version of the default compiler may be too old to be compatible with current modelE source code. In such case you may need to install the latest Developmant Tool Set. On CentOS you can do it with:
在企业Linux平台（如RedHat或CentOS）上，默认编译器的版本可能太旧，无法与当前的ModelE源代码兼容。在这种情况下，您可能需要安装最新的开发工具集。在CentOS上，您可以使用以下命令安装：

```bash
yum install centos-release-scl
yum install devtoolset-6
```

To use it in your current shell, you will need to enable it with:
要在当前shell中使用它，您需要使用以下命令启用：

```bash
scl enable devtoolset-6 bash
```

(make sure that your ~/.bashrc doesn't break it) or you can add:
（确保您的~/.bashrc不会破坏它）或者您可以添加：

```bash
source /opt/rh/devtoolset-6/enable
```

to your ~/.bashrc file, so that it is enabled automatically each time you start a new shell.
到您的~/.bashrc文件中，这样每次启动新shell时都会自动启用。

Once all necessary software is installed you can proceed to downloading the model source code:
一旦所有必要软件安装完成，您就可以继续下载模型源代码：

```bash
git clone simplex.giss.nasa.gov:/giss/gitrepo/modelE.git
```

Now switch to "decks" directory (that's where all "make" commands should be executed) and execute "make config":
现在切换到"decks"目录（这是所有"make"命令应该执行的地方）并执行"make config"：

```bash
cd modelE/decks
make config COMPILER=gfortran ModelE_Support=$HOME/ModelE_Support
```

Here "\$HOME/ModelE_Support" is a directory where you want modelE to store all its data (input files, administrative data, model output etc.). You can use a different path for it if you like. The "config" command will create a "ModelE_Support" directory with a necessary directory tree. It will also create a `~/.modelErc` config file with your global settings. You have to edit it to set the type of compiler and MPI distribution you are using and also the location of your netcdf and MPI libraries. For the software installed with MacPorts in the example above you will need to set:
这里"\$HOME/ModelE_Support"是您希望ModelE存储所有数据的目录（输入文件、管理数据、模型输出等）。如果您愿意，可以使用不同的路径。"config"命令将创建一个具有必要目录结构的"ModelE_Support"目录。它还将创建一个包含全局设置的`~/.modelErc`配置文件。您必须编辑它以设置您正在使用的编译器类型和MPI发行版，以及netcdf和MPI库的位置。对于上面示例中使用MacPorts安装的软件，您需要设置：

```bash
COMPILER=gfortran
NETCDFHOME=/opt/local
MPIDISTR=openmpi

MPIDIR=/opt/local
MPIINCLUDEDIR=/opt/local/include/openmpi-mp
MPILIBDIR=/opt/local/lib/openmpi-mp
```

On Linux machine, typically, you would not need the last three lines (if MPI package was installed with yum). Instead, you would need to load a corresponding shell module (see above). If you have compiled MPI library from the source, typically, you would need just to set `MPIDIR`, pointing it to the directory where you installed your MPI package.
在Linux机器上，通常您不需要最后三行（如果MPI包是用yum安装的）。相反，您需要加载相应的shell模块（见上文）。如果您从源代码编译了MPI库，通常您只需要设置`MPIDIR`，将其指向您安装MPI包的目录。

Your computer should now be ready to run modelE jobs, both serial and parallel ones.
现在您的计算机应该准备好运行ModelE作业了，包括串行和并行作业。

## Other options / 其他选项

If you want to use a different compiler, i.e. Intel `ifort` you should set:
如果您想使用不同的编译器，即Intel `ifort`，您应该设置：

```bash
COMPILER=intel
```

Standard installation of netcdf library assumes that the library files are located in \$NETCDFHOME/lib and its include files are in \$NETCDFHOME/include. If your computer uses a different setup you can specify these locations explicitly by setting the variables:
netcdf库的标准安装假设库文件位于\$NETCDFHOME/lib，其包含文件位于\$NETCDFHOME/include。如果您的计算机使用不同的设置，您可以通过设置变量显式指定这些位置：

```bash
NETCDFLIBDIR
NETCDFINCLUDEDIR
```

ModelE supports the following MPI distributions: intel, openmpi, mpich2, mvapich2, SCALI. Set MPIDISTR variable to the name of the distribution you are using. For example if you are using Intel MPI set:
ModelE支持以下MPI发行版：intel、openmpi、mpich2、mvapich2、SCALI。将MPIDISTR变量设置为您正在使用的发行版的名称。例如，如果您使用Intel MPI，设置：

```bash
MPIDISTR=intel
```

## Getting it work with default yum packages on CentOS 5 / 在CentOS 5上使用默认yum包使其工作

You will not be able to make it work with default NetCDF package - it was compiled with gfortran compiler which is too old. The compilation will fail at the time of linking. Instead, compile NetCDF from the source as described in Appendix.
您将无法使其与默认NetCDF包一起工作 - 它是用太旧的gfortran编译器编译的。编译将在链接时失败。相反，请按照附录中描述从源代码编译NetCDF。

You can use MPI package which comes with CentOS 5. Both OpenMPI and MPICH2 work, though OpenMPI would produce some warning messages during the execution and is less straightforward to configure. So, if you have to use precompiled MPI package with CentOS 5, we recommend using MPICH2.
您可以使用CentOS 5自带的MPI包。OpenMPI和MPICH2都可以工作，但OpenMPI在执行期间会产生一些警告消息，并且配置不太直接。因此，如果您必须在CentOS 5上使用预编译的MPI包，我们建议使用MPICH2。

MPICH2 seems to come pre-installed on CentOS 5 machines. If not, you have to "yum install" the packages "mpich2" and "mpich2-devel". MPICH2 is controlled by Linux modules, so before using it in a shell window you have to activate it with:
MPICH2似乎预装在CentOS 5机器上。如果没有，您必须"yum install" "mpich2"和"mpich2-devel"包。MPICH2由Linux模块控制，因此要在shell窗口中使用它之前，您必须使用以下命令激活：

```bash
module load mpich2-x86_64
```

(you may want to include this command into your ~/.profile or ~/.bashrc). MPICH2 uses a daemon for its communications, so one has to start it before starting any MPI jobs:
（您可能希望将此命令包含在您的~/.profile或~/.bashrc中）。MPICH2使用守护进程进行通信，因此必须在启动任何MPI作业之前启动它：

```bash
mpd &
```

It has to be started only once per session, so don't put it into your ~/.bashrc . Since information about MPICH2 is provided by a Linux module, you don't need to specify MPIDIR. So, variables in your ~/.modelErc should look like:
它只需要每个会话启动一次，所以不要将其放入您的~/.bashrc中。由于MPICH2信息由Linux模块提供，您不需要指定MPIDIR。因此，您的~/.modelErc中的变量应该看起来像：

```bash
COMPILER=gfortran
NETCDFHOME=/opt/netcdf/3.6.3
MPIDISTR=mpich2
```

Here it is assumed that you have installed your NetCDF library to `/opt/netcdf/3.6.3`.
这里假设您已将NetCDF库安装到`/opt/netcdf/3.6.3`。

---

## Configuration Notes / 配置说明

### Platform-Specific Instructions / 平台特定说明

Mac OS X / Mac OS X系统:
- MacPorts是推荐的安装方式
- 确保PATH中/opt/local/bin优先于系统目录
- 使用gcc49变体以确保兼容性

Linux (Fedora 22+) / Linux (Fedora 22+系统):
- 可以使用yum安装二进制包
- 建议从源代码编译netcdf和openmpi以确保兼容性

Enterprise Linux (CentOS/RedHat) / 企业Linux (CentOS/RedHat系统):
- 可能需要安装devtoolset-6以获得更新的编译器
- 使用scl enable devtoolset-6命令启用开发工具集

CentOS 5 Special Case / CentOS 5特殊情况:
- 默认NetCDF包太旧，必须从源代码编译
- 推荐使用MPICH2而非OpenMPI
- 需要启动mpd守护进程

### Configuration Variables / 配置变量说明

Required Variables / 必需变量:
- `COMPILER`: 编译器类型 (gfortran/intel)
- `NETCDFHOME`: NetCDF安装目录
- `MPIDISTR`: MPI发行版名称

Optional Variables / 可选变量:
- `MPIDIR`: MPI安装目录
- `MPIINCLUDEDIR`: MPI包含文件目录
- `MPILIBDIR`: MPI库文件目录
- `NETCDFLIBDIR`: NetCDF库文件目录
- `NETCDFINCLUDEDIR`: NetCDF包含文件目录

### Module System / 模块系统

Linux Modules / Linux模块:
```bash
module load openmpi-x86_64  # 或其他MPI模块
```

Activation Scripts / 激活脚本:
- 添加到~/.profile或~/.bashrc
- 使用scl enable devtoolset-6 bash (CentOS)
- 使用source /opt/rh/devtoolset-6/enable

### Troubleshooting / 故障排除

Common Issues / 常见问题:
1. 编译失败: 检查编译器版本和库兼容性
2. 找不到库文件: 验证NETCDFHOME和MPIDIR设置
3. MPI错误: 确保模块已加载或环境变量正确设置
4. 权限问题: 确保对安装目录有适当权限

Version Compatibility / 版本兼容性:
- gfortran 4.9+ (推荐5.0+)
- Intel ifort 12.0+
- NetCDF 3.6.3+ (推荐4.x)
- OpenMPI/MPICH2/MVAPICH2 最新稳定版

Platform note / 平台说明:
- 本文档中的命令示例基于历史环境版本，请根据本地环境调整
- MacPorts示例中的gcc49、devtoolset-6等为历史版本，现代系统可使用更新版本
- 包管理器命令可能因Linux发行版而异，请使用相应的包管理器（apt、dnf、zypper等）

Version note / 版本说明:
- git仓库地址可能需要更新为最新地址
- 软件包名称和版本可能随时间变化，请使用适合您系统的版本
- 配置参数名称保持不变，但路径需要根据实际安装位置调整
